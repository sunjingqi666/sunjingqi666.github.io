<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>校园聊天系统</title>
  <!-- 网站图标 -->
  <link rel="icon" href="https://picsum.photos/32/32?random=icon" type="image/png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3B82F6',
            secondary: '#10B981',
            accent: '#8B5CF6',
            dark: '#1E293B',
            light: '#F3F4F6',
          },
        }
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .message-box {
        max-height: calc(100vh - 240px);
      }
      .sidebar-height {
        height: calc(100vh - 64px);
      }
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <!-- 登录模态框 -->
  <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 w-full max-w-md">
      <h2 class="text-2xl font-bold mb-6 text-center text-dark">校园聊天系统</h2>
      
      <div id="loginError" class="hidden bg-red-100 text-red-700 p-3 rounded-lg mb-4"></div>
      
      <div class="mb-4">
        <label for="username" class="block text-sm font-medium text-gray-700 mb-1">用户名</label>
        <input type="text" id="username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
      </div>
      
      <div class="mb-6">
        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">密码</label>
        <input type="password" id="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
      </div>
      
      <button id="loginBtn" class="w-full bg-primary text-white py-3 rounded-lg hover:bg-primary/90 transition-colors font-medium">
        登录
      </button>
      
      <div class="mt-4 text-center text-sm text-gray-600">
        <p>超级管理员账号: superadmin</p>
        <p>默认密码: Super123456</p>
      </div>
    </div>
  </div>

  <!-- 主应用界面 -->
  <div id="app" class="hidden">
    <!-- 顶部导航 -->
    <header class="bg-white shadow-md py-3 px-6 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <i class="fa fa-comments text-primary text-2xl"></i>
        <h1 class="text-xl font-bold text-dark">校园聊天系统</h1>
      </div>
      
      <div class="flex items-center gap-4">
        <button id="announcementBtn" class="flex items-center gap-1 text-gray-700 hover:text-primary transition-colors">
          <i class="fa fa-bullhorn"></i>
          <span>公告</span>
        </button>
        <div class="flex items-center gap-2">
          <img id="userAvatar" src="https://picsum.photos/40/40?random=user" alt="用户头像" class="w-8 h-8 rounded-full object-cover">
          <span id="currentUser" class="font-medium"></span>
          <button id="logoutBtn" class="text-gray-500 hover:text-red-500 transition-colors">
            <i class="fa fa-sign-out"></i>
          </button>
        </div>
      </div>
    </header>

    <!-- 公告面板 -->
    <div id="announcementPanel" class="fixed top-0 right-0 h-full w-full md:w-96 bg-white shadow-xl transform translate-x-full transition-transform duration-300 z-40">
      <div class="p-6 border-b">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold text-dark">校园公告</h2>
          <button id="closeAnnouncement" class="text-gray-500 hover:text-gray-800">
            <i class="fa fa-times text-xl"></i>
          </button>
        </div>
        
        <!-- 管理员操作区 -->
        <div id="adminAnnouncementControls" class="hidden mb-4">
          <button id="addAnnouncementBtn" class="bg-secondary text-white px-4 py-2 rounded-lg hover:bg-secondary/90 transition-colors text-sm">
            <i class="fa fa-plus mr-1"></i> 添加公告
          </button>
        </div>
        
        <div id="announcementLoading" class="py-8 text-center">
          <i class="fa fa-spinner fa-spin text-primary text-2xl"></i>
          <p class="mt-2 text-gray-500">加载公告中...</p>
        </div>
        
        <div id="announcementError" class="hidden py-8 text-center text-red-500">
          <i class="fa fa-exclamation-circle text-2xl"></i>
          <p class="mt-2">加载公告失败，请重试</p>
        </div>
      </div>
      
      <div id="announcementList" class="p-4 overflow-y-auto h-[calc(100%-120px)]">
        <!-- 公告内容将通过JS动态加载 -->
      </div>
    </div>

    <!-- 添加公告模态框 -->
    <div id="addAnnouncementModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-xl p-6 w-full max-w-lg">
        <h3 class="text-xl font-bold mb-4 text-dark">发布新公告</h3>
        
        <div class="mb-4">
          <label for="announcementTitle" class="block text-sm font-medium text-gray-700 mb-1">标题</label>
          <input type="text" id="announcementTitle" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
        </div>
        
        <div class="mb-6">
          <label for="announcementContent" class="block text-sm font-medium text-gray-700 mb-1">内容</label>
          <textarea id="announcementContent" rows="5" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"></textarea>
        </div>
        
        <div class="flex justify-end gap-3">
          <button id="cancelAnnouncement" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors">
            取消
          </button>
          <button id="saveAnnouncement" class="px-4 py-2 bg-secondary text-white rounded-lg hover:bg-secondary/90 transition-colors">
            发布
          </button>
        </div>
      </div>
    </div>

    <!-- 主聊天区域 -->
    <div class="flex h-[calc(100vh-64px)]">
      <!-- 左侧用户列表 -->
      <div class="w-full md:w-80 bg-white border-r overflow-hidden">
        <div class="p-4 border-b">
          <h2 class="font-bold text-dark">在线用户</h2>
        </div>
        <div id="userList" class="p-2 overflow-y-auto sidebar-height">
          <!-- 用户列表将通过JS动态加载 -->
        </div>
      </div>
      
      <!-- 右侧聊天区域 -->
      <div class="flex-1 flex flex-col overflow-hidden">
        <div id="messageContainer" class="flex-1 p-4 overflow-y-auto message-box bg-gray-50">
          <!-- 聊天消息将通过JS动态加载 -->
          <div class="text-center text-gray-500 text-sm my-4">
            今天
          </div>
        </div>
        
        <div class="p-4 border-t bg-white">
          <div class="flex gap-3">
            <textarea id="messageInput" placeholder="输入消息..." class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary focus:border-primary resize-none"></textarea>
            <button id="sendMessage" class="bg-primary text-white p-3 rounded-lg hover:bg-primary/90 transition-colors">
              <i class="fa fa-paper-plane"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // LeanCloud初始化 - 请替换为你的应用信息
    AV.init({
      appId: "0q5QrQ2pGsms6GN3cUn3Xx7f-gzGzoHsz",
      appKey: "m7saMie87OiJizfHwzhcQaEc",
      serverURL: "https://0q5qrq2p.lc-cn-n1-shared.com"
    });

    // 全局变量
    let currentUser = null;
    let isSuperAdmin = false;
    let announcementQuery = null;
    let messageQuery = null;

    // DOM元素
    const loginModal = document.getElementById('loginModal');
    const app = document.getElementById('app');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const loginError = document.getElementById('loginError');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const currentUserEl = document.getElementById('currentUser');
    const userAvatar = document.getElementById('userAvatar');
    const userList = document.getElementById('userList');
    const messageContainer = document.getElementById('messageContainer');
    const messageInput = document.getElementById('messageInput');
    const sendMessage = document.getElementById('sendMessage');
    const announcementBtn = document.getElementById('announcementBtn');
    const announcementPanel = document.getElementById('announcementPanel');
    const closeAnnouncement = document.getElementById('closeAnnouncement');
    const announcementList = document.getElementById('announcementList');
    const announcementLoading = document.getElementById('announcementLoading');
    const announcementError = document.getElementById('announcementError');
    const adminAnnouncementControls = document.getElementById('adminAnnouncementControls');
    const addAnnouncementBtn = document.getElementById('addAnnouncementBtn');
    const addAnnouncementModal = document.getElementById('addAnnouncementModal');
    const cancelAnnouncement = document.getElementById('cancelAnnouncement');
    const saveAnnouncement = document.getElementById('saveAnnouncement');

    // 页面加载时检查登录状态
    document.addEventListener('DOMContentLoaded', async () => {
      // 初始化必要的数据表
      await initTables();
      
      // 检查当前登录状态
      currentUser = AV.User.current();
      if (currentUser) {
        await handleLoginSuccess(currentUser);
      } else {
        // 确保超级管理员存在
        await ensureSuperAdminExists();
        loginModal.classList.remove('hidden');
      }
      
      // 绑定事件监听
      bindEvents();
    });

    // 初始化数据表
    async function initTables() {
      try {
        // 检查并创建公告表
        const announcementSchema = new AV.Schema('Announcement');
        if (!announcementSchema.hasField('title')) {
          announcementSchema.addField('title', { type: 'String' });
        }
        if (!announcementSchema.hasField('content')) {
          announcementSchema.addField('content', { type: 'String' });
        }
        if (!announcementSchema.hasField('author')) {
          announcementSchema.addField('author', { type: 'Pointer', targetClass: '_User' });
        }
        if (!announcementSchema.hasField('createdAt')) {
          announcementSchema.addField('createdAt', { type: 'Date' });
        }
        await announcementSchema.save();
        
        // 检查并创建消息表
        const messageSchema = new AV.Schema('Message');
        if (!messageSchema.hasField('content')) {
          messageSchema.addField('content', { type: 'String' });
        }
        if (!messageSchema.hasField('sender')) {
          messageSchema.addField('sender', { type: 'Pointer', targetClass: '_User' });
        }
        if (!messageSchema.hasField('createdAt')) {
          messageSchema.addField('createdAt', { type: 'Date' });
        }
        await messageSchema.save();
        
        console.log('数据表初始化成功');
      } catch (error) {
        console.log('数据表初始化失败:', error);
      }
    }

    // 确保超级管理员存在
    async function ensureSuperAdminExists() {
      try {
        const adminUsername = 'superadmin';
        const adminPassword = 'Super123456';
        
        // 查询是否存在超级管理员
        const query = new AV.Query('_User');
        query.equalTo('username', adminUsername);
        const existingUser = await query.first();
        
        if (!existingUser) {
          // 创建超级管理员
          const user = new AV.User();
          user.setUsername(adminUsername);
          user.setPassword(adminPassword);
          await user.signUp();
          
          // 创建用户资料，标记为超级管理员
          const UserProfile = AV.Object.extend('UserProfile');
          const profile = new UserProfile();
          profile.set('userId', user.id);
          profile.set('nickname', '超级管理员');
          profile.set('isSuper', true);
          await profile.save();
          
          console.log('超级管理员创建成功');
        } else {
          console.log('超级管理员已存在');
        }
      } catch (error) {
        console.error('确保超级管理员存在失败:', error);
        showLoginError('初始化管理员失败，请稍后重试');
      }
    }

    // 绑定事件处理函数
    function bindEvents() {
      // 登录按钮
      loginBtn.addEventListener('click', handleLogin);
      
      // 按回车键登录
      passwordInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          handleLogin();
        }
      });
      
      // 登出按钮
      logoutBtn.addEventListener('click', handleLogout);
      
      // 发送消息
      sendMessage.addEventListener('click', sendChatMessage);
      
      // 按回车键发送消息
      messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendChatMessage();
        }
      });
      
      // 公告面板控制
      announcementBtn.addEventListener('click', () => {
        announcementPanel.classList.remove('translate-x-full');
        loadAnnouncements();
      });
      
      closeAnnouncement.addEventListener('click', () => {
        announcementPanel.classList.add('translate-x-full');
      });
      
      // 管理员公告操作
      addAnnouncementBtn.addEventListener('click', () => {
        addAnnouncementModal.classList.remove('hidden');
      });
      
      cancelAnnouncement.addEventListener('click', () => {
        addAnnouncementModal.classList.add('hidden');
        document.getElementById('announcementTitle').value = '';
        document.getElementById('announcementContent').value = '';
      });
      
      saveAnnouncement.addEventListener('click', saveNewAnnouncement);
    }

    // 处理登录
    async function handleLogin() {
      const username = usernameInput.value.trim();
      const password = passwordInput.value.trim();
      
      if (!username || !password) {
        showLoginError('请输入用户名和密码');
        return;
      }
      
      try {
        const user = await AV.User.logIn(username, password);
        await handleLoginSuccess(user);
      } catch (error) {
        console.error('登录失败:', error);
        showLoginError('登录失败: ' + error.message);
      }
    }

    // 登录成功处理
    async function handleLoginSuccess(user) {
      currentUser = user;
      currentUserEl.textContent = user.getUsername();
      
      // 检查是否为超级管理员
      await checkIfSuperAdmin(user);
      
      // 隐藏登录模态框，显示应用
      loginModal.classList.add('hidden');
      app.classList.remove('hidden');
      
      // 加载用户列表
      loadUserList();
      
      // 加载历史消息
      loadMessages();
      
      // 如果是管理员，显示公告管理按钮
      if (isSuperAdmin) {
        adminAnnouncementControls.classList.remove('hidden');
      }
      
      // 设置实时消息监听
      setupMessageListener();
    }

    // 检查是否为超级管理员
    async function checkIfSuperAdmin(user) {
      try {
        const query = new AV.Query('UserProfile');
        query.equalTo('userId', user.id);
        query.equalTo('isSuper', true);
        const profile = await query.first();
        
        isSuperAdmin = !!profile;
        console.log('是否为超级管理员:', isSuperAdmin);
        return isSuperAdmin;
      } catch (error) {
        console.error('检查管理员权限失败:', error);
        isSuperAdmin = false;
        return false;
      }
    }

    // 处理登出
    async function handleLogout() {
      try {
        await AV.User.logOut();
        currentUser = null;
        isSuperAdmin = false;
        
        // 移除实时监听
        if (messageQuery) {
          messageQuery.off('create');
        }
        if (announcementQuery) {
          announcementQuery.off('create');
        }
        
        // 重置UI
        app.classList.add('hidden');
        loginModal.classList.remove('hidden');
        usernameInput.value = '';
        passwordInput.value = '';
        
        console.log('登出成功');
      } catch (error) {
        console.error('登出失败:', error);
        alert('登出失败: ' + error.message);
      }
    }

    // 加载用户列表
    async function loadUserList() {
      try {
        const query = new AV.Query('_User');
        const users = await query.find();
        
        userList.innerHTML = '';
        users.forEach(user => {
          const isCurrentUser = user.id === currentUser.id;
          const userItem = document.createElement('div');
          userItem.className = `flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 transition-colors ${isCurrentUser ? 'bg-blue-50' : ''}`;
          userItem.innerHTML = `
            <img src="https://picsum.photos/48/48?random=${user.id}" alt="${user.getUsername()}" class="w-10 h-10 rounded-full object-cover">
            <div>
              <div class="font-medium">${user.getUsername()}</div>
              <div class="text-xs text-gray-500">${isCurrentUser ? '你' : '在线'}</div>
            </div>
          `;
          userList.appendChild(userItem);
        });
      } catch (error) {
        console.error('加载用户列表失败:', error);
        alert('加载用户列表失败: ' + error.message);
      }
    }

    // 加载消息
    async function loadMessages() {
      try {
        const query = new AV.Query('Message');
        query.include('sender');
        query.descending('createdAt');
        query.limit(50);
        const messages = await query.find();
        
        // 清空消息容器（保留日期标签）
        const dateDiv = messageContainer.querySelector('.text-center');
        messageContainer.innerHTML = '';
        if (dateDiv) {
          messageContainer.appendChild(dateDiv);
        }
        
        // 反向显示（最新的在底部）
        messages.reverse().forEach(message => {
          addMessageToUI(message);
        });
        
        // 滚动到底部
        scrollToBottom();
      } catch (error) {
        console.error('加载消息失败:', error);
        alert('加载消息失败: ' + error.message);
      }
    }

    // 设置消息监听
    function setupMessageListener() {
      messageQuery = new AV.Query('Message');
      messageQuery.include('sender');
      messageQuery.greaterThan('createdAt', new Date());
      
      messageQuery.subscribe().then(subscription => {
        subscription.on('create', (message) => {
          addMessageToUI(message);
          scrollToBottom();
        });
      }).catch(error => {
        console.error('设置消息监听失败:', error);
      });
    }

    // 发送聊天消息
    async function sendChatMessage() {
      const content = messageInput.value.trim();
      if (!content) return;
      
      try {
        const Message = AV.Object.extend('Message');
        const message = new Message();
        
        message.set('content', content);
        message.set('sender', AV.User.current());
        
        await message.save();
        messageInput.value = '';
      } catch (error) {
        console.error('发送消息失败:', error);
        alert('发送消息失败: ' + error.message);
      }
    }

    // 添加消息到UI
    function addMessageToUI(message) {
      const sender = message.get('sender');
      const isCurrentUser = sender.id === currentUser.id;
      const content = message.get('content');
      const time = formatTime(message.get('createdAt'));
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `mb-4 flex ${isCurrentUser ? 'justify-end' : 'justify-start'}`;
      
      messageDiv.innerHTML = `
        <div class="${isCurrentUser ? 'items-end' : 'items-start'} flex gap-2 max-w-[80%]">
          ${!isCurrentUser ? `
            <img src="https://picsum.photos/40/40?random=${sender.id}" alt="${sender.getUsername()}" class="w-8 h-8 rounded-full object-cover">
          ` : ''}
          <div>
            ${!isCurrentUser ? `<div class="text-xs text-gray-500 mb-1">${sender.getUsername()}</div>` : ''}
            <div class="${isCurrentUser ? 'bg-primary text-white' : 'bg-white text-gray-800'} p-3 rounded-lg rounded-tl-none shadow-sm">
              ${content}
            </div>
            <div class="text-xs text-gray-400 mt-1 ${isCurrentUser ? 'text-right' : ''}">${time}</div>
          </div>
        </div>
      `;
      
      messageContainer.appendChild(messageDiv);
    }

    // 加载公告
    async function loadAnnouncements() {
      try {
        announcementLoading.classList.remove('hidden');
        announcementError.classList.add('hidden');
        announcementList.innerHTML = '';
        
        const query = new AV.Query('Announcement');
        query.include('author');
        query.descending('createdAt');
        const announcements = await query.find();
        
        if (announcements.length === 0) {
          announcementList.innerHTML = `
            <div class="text-center py-8 text-gray-500">
              <i class="fa fa-info-circle text-xl mb-2"></i>
              <p>暂无公告</p>
            </div>
          `;
        } else {
          announcements.forEach(announcement => {
            addAnnouncementToUI(announcement);
          });
        }
        
        // 设置公告实时监听
        setupAnnouncementListener();
      } catch (error) {
        console.error('加载公告失败:', error);
        announcementLoading.classList.add('hidden');
        announcementError.classList.remove('hidden');
      } finally {
        announcementLoading.classList.add('hidden');
      }
    }

    // 设置公告监听
    function setupAnnouncementListener() {
      if (announcementQuery) {
        announcementQuery.off('create');
      }
      
      announcementQuery = new AV.Query('Announcement');
      announcementQuery.include('author');
      announcementQuery.greaterThan('createdAt', new Date());
      
      announcementQuery.subscribe().then(subscription => {
        subscription.on('create', (announcement) => {
          // 在列表顶部添加新公告
          const firstChild = announcementList.firstChild;
          const announcementEl = createAnnouncementElement(announcement);
          
          if (firstChild) {
            announcementList.insertBefore(announcementEl, firstChild);
          } else {
            announcementList.appendChild(announcementEl);
          }
          
          // 显示新公告提示
          showNewAnnouncementNotification();
        });
      }).catch(error => {
        console.error('设置公告监听失败:', error);
      });
    }

    // 添加公告到UI
    function addAnnouncementToUI(announcement) {
      const announcementEl = createAnnouncementElement(announcement);
      announcementList.appendChild(announcementEl);
    }

    // 创建公告元素
    function createAnnouncementElement(announcement) {
      const author = announcement.get('author');
      const title = announcement.get('title');
      const content = announcement.get('content');
      const time = formatDate(announcement.get('createdAt'));
      
      const announcementEl = document.createElement('div');
      announcementEl.className = 'mb-6 p-4 border border-gray-200 rounded-lg hover:shadow-md transition-shadow';
      
      // 如果是管理员，添加删除按钮
      const deleteBtn = isSuperAdmin ? `
        <button class="delete-announcement text-red-500 hover:text-red-700 ml-2" data-id="${announcement.id}">
          <i class="fa fa-trash"></i>
        </button>
      ` : '';
      
      announcementEl.innerHTML = `
        <div class="flex justify-between items-start mb-2">
          <h3 class="font-bold text-lg">${title}</h3>
          <div class="flex items-center">
            <span class="text-xs text-gray-500">${time}</span>
            ${deleteBtn}
          </div>
        </div>
        <div class="text-gray-700 mb-3">${content}</div>
        <div class="text-sm text-gray-500">
          发布者: ${author ? author.getUsername() : '系统'}
        </div>
      `;
      
      // 如果是管理员，绑定删除事件
      if (isSuperAdmin) {
        announcementEl.querySelector('.delete-announcement').addEventListener('click', async (e) => {
          e.stopPropagation();
          const id = e.currentTarget.getAttribute('data-id');
          await deleteAnnouncement(id);
          announcementEl.remove();
        });
      }
      
      return announcementEl;
    }

    // 保存新公告
    async function saveNewAnnouncement() {
      const title = document.getElementById('announcementTitle').value.trim();
      const content = document.getElementById('announcementContent').value.trim();
      
      if (!title || !content) {
        alert('请填写公告标题和内容');
        return;
      }
      
      try {
        const Announcement = AV.Object.extend('Announcement');
        const announcement = new Announcement();
        
        announcement.set('title', title);
        announcement.set('content', content);
        announcement.set('author', AV.User.current());
        
        await announcement.save();
        
        // 关闭模态框并清空输入
        addAnnouncementModal.classList.add('hidden');
        document.getElementById('announcementTitle').value = '';
        document.getElementById('announcementContent').value = '';
        
        // 重新加载公告列表
        loadAnnouncements();
      } catch (error) {
        console.error('发布公告失败:', error);
        alert('发布公告失败: ' + error.message);
      }
    }

    // 删除公告
    async function deleteAnnouncement(id) {
      if (!confirm('确定要删除这条公告吗？')) {
        return;
      }
      
      try {
        const announcement = AV.Object.createWithoutData('Announcement', id);
        await announcement.destroy();
        console.log('公告删除成功');
      } catch (error) {
        console.error('删除公告失败:', error);
        alert('删除公告失败: ' + error.message);
      }
    }

    // 显示新公告通知
    function showNewAnnouncementNotification() {
      const notification = document.createElement('div');
      notification.className = 'fixed top-20 right-4 bg-secondary text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-bounce';
      notification.textContent = '有新公告发布';
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // 显示登录错误
    function showLoginError(message) {
      loginError.textContent = message;
      loginError.classList.remove('hidden');
      
      // 3秒后自动隐藏
      setTimeout(() => {
        loginError.classList.add('hidden');
      }, 3000);
    }

    // 滚动到底部
    function scrollToBottom() {
      messageContainer.scrollTop = messageContainer.scrollHeight;
    }

    // 格式化时间
    function formatTime(date) {
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      return `${hours}:${minutes}`;
    }

    // 格式化日期
    function formatDate(date) {
      const year = date.getFullYear();
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const day = date.getDate().toString().padStart(2, '0');
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      return `${year}-${month}-${day} ${hours}:${minutes}`;
    }
  </script>
</body>
</html>
