<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://picsum.photos/32/32?random=lemon" type="image/png">
    <title>Lemon - 管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
    
    <!-- Tailwind配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F86F7',
                        secondary: '#6B5CA5',
                        primary2: '#FF7F50',
                        secondary2: '#FF69B4',
                        primary3: '#2E8B57',
                        secondary3: '#8B4513',
                        accent: '#FFB344',
                        dark: '#2C3E50',
                        light: '#F8FAFC',
                    },
                    fontFamily: {
                        main: ['"Nunito"', '"Segoe UI"', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto { content-visibility: auto; }
            .text-shadow { text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1); }
            .btn-effect { @apply transition-all duration-200 hover:shadow-md active:scale-95; }
            .sidebar-btn { @apply w-full text-left px-4 py-3 rounded-xl flex items-center space-x-3 hover:bg-gray-100 hover:shadow-sm transition-all duration-200; }
            .sidebar-btn-active { @apply bg-primary/10 text-primary font-medium; }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- 主题样式 -->
    <style>
        body.theme1 { --color-primary: #4F86F7; --color-secondary: #6B5CA5; --color-text: #2C3E50; --color-bg: #F8FAFC; }
        body.theme2 { --color-primary: #FF7F50; --color-secondary: #FF69B4; --color-text: #332211; --color-bg: #FFF8F5; }
        body.theme3 { --color-primary: #2E8B57; --color-secondary: #8B4513; --color-text: #222222; --color-bg: #F5F7F0; }
        
        body { background-color: var(--color-bg); color: var(--color-text); }
        .bg-primary { background-color: var(--color-primary); }
        .bg-secondary { background-color: var(--color-secondary); }
        .text-primary { color: var(--color-primary); }
        .text-secondary { color: var(--color-secondary); }
        .border-primary { border-color: var(--color-primary); }
        .gradient-primary { background: linear-gradient(to right, var(--color-primary), var(--color-secondary)); }
    </style>
</head>
<body class="min-h-screen font-main theme1">
    <!-- 顶部导航栏 -->
    <header class="sticky top-0 z-50 bg-white/90 backdrop-blur-md shadow-md transition-all duration-300">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <!-- Logo -->
            <div class="flex items-center space-x-2">
                <div class="w-10 h-10 rounded-full gradient-primary flex items-center justify-center">
                    <i class="fa fa-lemon-o text-white text-xl"></i>
                </div>
                <h1 class="text-2xl font-bold bg-clip-text text-transparent gradient-primary">Lemon</h1>
            </div>
            
            <!-- 主题切换 -->
            <div class="flex items-center space-x-2">
                <button onclick="switchTheme('theme1')" class="theme-btn px-3 py-1 rounded-md border border-primary/30 text-sm btn-effect">清新蓝</button>
                <button onclick="switchTheme('theme2')" class="theme-btn px-3 py-1 rounded-md border border-primary2/30 text-sm btn-effect">活力橙</button>
                <button onclick="switchTheme('theme3')" class="theme-btn px-3 py-1 rounded-md border border-primary3/30 text-sm btn-effect">森系绿</button>
            </div>
            
            <!-- 用户区域 -->
            <div class="flex items-center space-x-4">
                <div id="userMenu" class="relative">
                    <button id="userAvatarBtn" class="flex items-center space-x-2 focus:outline-none btn-effect">
                        <div id="userAvatar" class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden border-2 border-primary/50 transition-transform hover:scale-110">
                            <img src="https://picsum.photos/200/200?random=1" alt="用户头像" class="w-full h-full object-cover">
                        </div>
                        <span id="userNickname" class="hidden md:inline font-medium">游客</span>
                        <i class="fa fa-angle-down text-gray-500"></i>
                    </button>
                    <div id="avatarDropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl overflow-hidden hidden z-50">
                        <div class="p-3 border-b">
                            <p id="dropdownNickname" class="font-bold">游客</p>
                            <p id="dropdownRole" class="text-sm text-gray-500">未登录</p>
                        </div>
                        <button id="profileBtn" class="w-full text-left px-4 py-2 hover:bg-gray-50 transition-colors">
                            <i class="fa fa-user-circle mr-2 text-primary"></i>个人中心
                        </button>
                        <button id="adminBtn" class="w-full text-left px-4 py-2 hover:bg-gray-50 transition-colors hidden">
                            <i class="fa fa-crown mr-2 text-accent"></i>管理中心
                        </button>
                        <button id="logoutBtn" class="w-full text-left px-4 py-2 hover:bg-gray-50 transition-colors">
                            <i class="fa fa-sign-out mr-2 text-red-500"></i>退出登录
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 py-6 flex flex-col md:flex-row gap-6">
        <!-- 侧边栏 -->
        <aside class="md:w-64 lg:w-72 shrink-0">
            <div class="bg-white rounded-2xl shadow-lg p-4 sticky top-24">
                <nav class="space-y-1">
                    <button class="sidebar-btn sidebar-btn-active" data-target="homeContent">
                        <i class="fa fa-home text-xl w-6 text-center"></i>
                        <span>首页</span>
                    </button>
                    <button class="sidebar-btn" data-target="friendsContent">
                        <i class="fa fa-users text-xl w-6 text-center"></i>
                        <span>好友列表</span>
                        <span class="ml-auto bg-primary text-white text-xs px-2 py-1 rounded-full">0</span>
                    </button>
                    <button class="sidebar-btn" data-target="qaContent">
                        <i class="fa fa-question-circle text-xl w-6 text-center"></i>
                        <span>互助问答</span>
                    </button>
                    <button class="sidebar-btn" data-target="activityContent">
                        <i class="fa fa-calendar text-xl w-6 text-center"></i>
                        <span>活动中心</span>
                    </button>
                    <button class="sidebar-btn" data-target="noticeContent">
                        <i class="fa fa-bullhorn text-xl w-6 text-center"></i>
                        <span>通知公告</span>
                    </button>
                </nav>
                
                <div class="mt-6 pt-6 border-t border-gray-100">
                    <h3 class="px-4 text-sm font-medium text-gray-500 mb-2">快速链接</h3>
                    <nav class="space-y-1">
                        <button class="sidebar-btn">
                            <i class="fa fa-cog text-xl w-6 text-center"></i>
                            <span>系统设置</span>
                        </button>
                        <button class="sidebar-btn">
                            <i class="fa fa-question-circle text-xl w-6 text-center"></i>
                            <span>帮助中心</span>
                        </button>
                    </nav>
                </div>
            </div>
        </aside>
        
        <!-- 主内容 -->
        <div class="flex-1">
            <!-- 抽签功能 -->
            <div id="lotterySection" class="bg-white rounded-2xl shadow-xl p-6 md:p-8 mb-6 transform transition-all hover:shadow-2xl">
                <h2 class="text-2xl font-bold mb-3 flex items-center">
                    <i class="fa fa-random text-primary mr-2"></i>今日运势抽签
                </h2>
                <p class="text-gray-500 mb-4">每日限抽1次，纯属娱乐~ 看看今天的小幸运吧 🍀</p>
                
                <div class="flex flex-col md:flex-row gap-6 items-center">
                    <div class="flex-1">
                        <button id="drawLotteryBtn" class="w-full gradient-primary text-white py-3 rounded-xl font-medium btn-effect flex items-center justify-center">
                            <i class="fa fa-magic mr-2"></i>点击抽签
                        </button>
                        <p id="lotteryLimitHint" class="text-center text-sm text-gray-500 mt-2 hidden">
                            今日已抽过签，明天再来吧~
                        </p>
                    </div>
                    
                    <!-- 抽签结果展示区 -->
                    <div id="lotteryResult" class="w-full md:w-2/3 hidden">
                        <div class="border-2 dashed border-primary rounded-xl p-4 bg-gray-50">
                            <div class="flex flex-col items-center">
                                <h3 id="lotteryType" class="text-xl font-bold mb-2 text-primary">大吉</h3>
                                <img id="lotteryImage" src="https://picsum.photos/200/200?random=lot1" alt="签运图片" class="w-32 h-32 object-cover rounded-lg mb-3 shadow-md">
                                
                                <div class="w-full grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                                    <div>
                                        <p class="text-sm font-medium text-green-600 mb-1"><i class="fa fa-check-circle mr-1"></i>宜</p>
                                        <p id="lotteryLucky" class="text-sm text-gray-600">写作业、听音乐、多喝水</p>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-red-600 mb-1"><i class="fa fa-times-circle mr-1"></i>忌</p>
                                        <p id="lotteryUnlucky" class="text-sm text-gray-600">熬夜、吃辛辣、久坐</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 登录/注册卡片 -->
            <div id="authCard" class="bg-white rounded-2xl shadow-xl p-6 md:p-8 mb-6 transform transition-all hover:shadow-2xl">
                <div class="text-center mb-6">
                    <h2 class="text-3xl font-bold mb-2">欢迎回来</h2>
                    <p class="text-gray-500">请登录你的账号</p>
                </div>
                
                <!-- 登录表单 -->
                <div id="loginForm">
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1" for="loginUsername">昵称</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                                <i class="fa fa-user"></i>
                            </span>
                            <input type="text" id="loginUsername" placeholder="请输入昵称" 
                                class="w-full pl-10 pr-4 py-3 rounded-xl border-2 border-primary/30 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all"
                                value="lemon"> <!-- 默认填充测试账号 -->
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium mb-1" for="loginPassword">密码</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                                <i class="fa fa-lock"></i>
                            </span>
                            <input type="password" id="loginPassword" placeholder="请输入8位密码" 
                                class="w-full pl-10 pr-10 py-3 rounded-xl border-2 border-primary/30 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all">
                            <button type="button" class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 toggle-password">
                                <i class="fa fa-eye"></i>
                            </button>
                            <p id="passwordError" class="mt-1 text-xs text-red-500 hidden">密码必须为8位</p>
                        </div>
                    </div>
                    
                    <button id="loginBtn" class="w-full gradient-primary text-white py-3 rounded-xl font-medium hover:opacity-90 transition-opacity mb-4 btn-effect">
                        登录
                    </button>
                    
                    <div class="text-center text-sm">
                        <p>还没有账号？ <button id="showRegisterBtn" class="text-primary font-medium btn-effect">立即注册</button></p>
                    </div>
                </div>
                
                <!-- 注册表单 -->
                <div id="registerForm" class="hidden">
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1" for="regUsername">昵称</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                                <i class="fa fa-user"></i>
                            </span>
                            <input type="text" id="regUsername" placeholder="请设置昵称" 
                                class="w-full pl-10 pr-4 py-3 rounded-xl border-2 border-primary/30 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all">
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium mb-1" for="regPassword">密码</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                                <i class="fa fa-lock"></i>
                            </span>
                            <input type="password" id="regPassword" placeholder="请设置8位密码" 
                                class="w-full pl-10 pr-10 py-3 rounded-xl border-2 border-primary/30 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all">
                            <button type="button" class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 toggle-password">
                                <i class="fa fa-eye"></i>
                            </button>
                            <p id="regPasswordError" class="mt-1 text-xs text-red-500 hidden">密码必须为8位</p>
                        </div>
                    </div>
                    
                    <button id="registerBtn" class="w-full gradient-primary text-white py-3 rounded-xl font-medium hover:opacity-90 transition-opacity mb-4 btn-effect">
                        注册
                    </button>
                    
                    <div class="text-center text-sm">
                        <p>已有账号？ <button id="showLoginBtn" class="text-primary font-medium btn-effect">立即登录</button></p>
                    </div>
                </div>
            </div>
            
            <!-- 首页内容（登录后显示） -->
            <div id="homeContent" class="hidden">
                <div class="bg-gradient-to-r from-primary/10 to-secondary/10 rounded-2xl p-6 md:p-8 mb-6 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-40 h-40 bg-accent/10 rounded-full -mr-20 -mt-20"></div>
                    <div class="absolute bottom-0 left-0 w-60 h-60 bg-primary/10 rounded-full -ml-30 -mb-30"></div>
                    
                    <div class="relative z-10 flex flex-col md:flex-row items-start md:items-center justify-between">
                        <div>
                            <h2 class="text-2xl md:text-3xl font-bold mb-2">欢迎回来，<span id="welcomeNickname">用户</span>！</h2>
                            <p class="text-gray-600" id="welcomeRole">普通用户</p>
                        </div>
                        
                        <div class="mt-4 md:mt-0 flex space-x-3">
                            <button class="bg-white text-primary px-4 py-2 rounded-lg shadow hover:shadow-md transition-shadow flex items-center btn-effect">
                                <i class="fa fa-plus mr-2"></i>发布动态
                            </button>
                            <button class="bg-white text-secondary px-4 py-2 rounded-lg shadow hover:shadow-md transition-shadow btn-effect">
                                <i class="fa fa-envelope"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 功能卡片 -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white rounded-2xl shadow-lg p-6 hover:shadow-xl transition-shadow transform hover:-translate-y-1 duration-300">
                        <div class="w-12 h-12 bg-primary/20 rounded-xl flex items-center justify-center mb-4">
                            <i class="fa fa-users text-primary text-xl"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-2">好友管理</h3>
                        <p class="text-gray-600 text-sm mb-4">查看好友列表，添加新好友，维系社交关系</p>
                        <button id="toFriendsBtn" class="text-primary font-medium flex items-center btn-effect">
                            查看好友 <i class="fa fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                    
                    <div class="bg-white rounded-2xl shadow-lg p-6 hover:shadow-xl transition-shadow transform hover:-translate-y-1 duration-300">
                        <div class="w-12 h-12 bg-secondary/20 rounded-xl flex items-center justify-center mb-4">
                            <i class="fa fa-question-circle text-secondary text-xl"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-2">互助问答</h3>
                        <p class="text-gray-600 text-sm mb-4">提出你的疑问，解答他人困惑，共同进步</p>
                        <button class="text-secondary font-medium flex items-center btn-effect">
                            进入问答 <i class="fa fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                    
                    <div class="bg-white rounded-2xl shadow-lg p-6 hover:shadow-xl transition-shadow transform hover:-translate-y-1 duration-300">
                        <div class="w-12 h-12 bg-accent/20 rounded-xl flex items-center justify-center mb-4">
                            <i class="fa fa-calendar text-accent text-xl"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-2">活动中心</h3>
                        <p class="text-gray-600 text-sm mb-4">浏览最新活动，报名参与，丰富生活</p>
                        <button class="text-accent font-medium flex items-center btn-effect">
                            查看活动 <i class="fa fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 其他页面内容 -->
            <div id="friendsContent" class="hidden"><div class="bg-white rounded-2xl shadow-lg p-6 mb-6"><h2 class="text-2xl font-bold mb-4">好友列表</h2></div></div>
            <div id="qaContent" class="hidden"><div class="bg-white rounded-2xl shadow-lg p-6 mb-6"><h2 class="text-2xl font-bold mb-4">互助问答</h2></div></div>
            <div id="activityContent" class="hidden"><div class="bg-white rounded-2xl shadow-lg p-6 mb-6"><h2 class="text-2xl font-bold mb-4">活动中心</h2></div></div>
            <div id="noticeContent" class="hidden"><div class="bg-white rounded-2xl shadow-lg p-6 mb-6"><h2 class="text-2xl font-bold mb-4">通知公告</h2></div></div>
            <div id="profileContent" class="hidden"><div class="bg-white rounded-2xl shadow-lg p-6 mb-6"><h2 class="text-2xl font-bold mb-4">个人中心</h2></div></div>
            <div id="adminContent" class="hidden"><div class="bg-white rounded-2xl shadow-lg p-6 mb-6"><h2 class="text-2xl font-bold mb-4">管理中心</h2></div></div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-dark text-white py-10 mt-10">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between">
                <div class="mb-6 md:mb-0">
                    <div class="flex items-center space-x-2 mb-4">
                        <div class="w-10 h-10 rounded-full gradient-primary flex items-center justify-center">
                            <i class="fa fa-lemon-o text-white text-xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold">Lemon</h2>
                    </div>
                    <p class="text-gray-400 max-w-md">简洁高效的管理系统，连接每一位用户，提供优质体验。</p>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-3 gap-8">
                    <div>
                        <h3 class="text-lg font-bold mb-4">快速链接</h3>
                        <ul class="space-y-2 text-gray-400">
                            <li><a href="#" class="hover:text-primary transition-colors">首页</a></li>
                            <li><a href="#" class="hover:text-primary transition-colors">互助问答</a></li>
                            <li><a href="#" class="hover:text-primary transition-colors">活动中心</a></li>
                        </ul>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-bold mb-4">关于我们</h3>
                        <ul class="space-y-2 text-gray-400">
                            <li><a href="#" class="hover:text-primary transition-colors">关于系统</a></li>
                            <li><a href="#" class="hover:text-primary transition-colors">使用帮助</a></li>
                            <li><a href="#" class="hover:text-primary transition-colors">联系我们</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="border-t border-white/10 mt-8 pt-8 text-center text-gray-500 text-sm">
                <p>© 2025 lemon版权所有</p>
            </div>
        </div>
    </footer>

    <!-- 提示弹窗 -->
    <div id="successToast" class="fixed bottom-6 right-6 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center z-50">
        <i class="fa fa-check-circle mr-2"></i>
        <span id="successMessage">操作成功</span>
    </div>
    <div id="errorToast" class="fixed bottom-6 right-6 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center z-50">
        <i class="fa fa-exclamation-circle mr-2"></i>
        <span id="errorMessage">操作失败</span>
    </div>

    <script>
        // 关键修复1：正确初始化LeanCloud（使用你提供的有效密钥）
        AV.init({
            appId: "30kUc571qTv0YSCTWVGRbAxk-gzGzoHsz",
            appKey: "LxFqgqjRZ3SaRGYUGznRiWAr",
            serverURL: "https://30kuc571.lc-cn-n1-shared.com"
        });

        // 配置和状态管理
        const Config = { ROLES: { SUPER_ADMIN: 'super_admin', ADMIN: 'admin', USER: 'user' } };
        const State = { currentUser: null, currentRole: Config.ROLES.USER, isLoggedIn: false };

        // 抽签数据
        const LotteryData = {
            types: [
                { name: "大吉", icon: "https://picsum.photos/200/200?random=lot1", description: "运势极佳" },
                { name: "小吉", icon: "https://picsum.photos/200/200?random=lot2", description: "小有好运" },
                { name: "中平", icon: "https://picsum.photos/200/200?random=lot3", description: "运势平平" },
                { name: "凶", icon: "https://picsum.photos/200/200?random=lot4", description: "需谨慎行事" },
                { name: "大凶", icon: "https://picsum.photos/200/200?random=lot5", description: "万事小心" }
            ],
            lucky: ["写作业", "听音乐", "多喝水", "散步", "阅读"],
            unlucky: ["熬夜", "吃辛辣", "久坐", "发脾气", "拖延"]
        };

        // 工具函数
        const Utils = {
            showToast: (type, message) => {
                const toast = document.getElementById(`${type}Toast`);
                const msgEl = document.getElementById(`${type}Message`);
                msgEl.textContent = message;
                toast.classList.remove('translate-y-20', 'opacity-0');
                setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
            },
            randomPick: (arr, count = 3) => [...arr].sort(() => 0.5 - Math.random()).slice(0, count).join('、'),
            getToday: () => {
                const d = new Date();
                return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')}`;
            }
        };

        // 抽签功能
        const Lottery = {
            init: () => {
                const lastDraw = localStorage.getItem('lastLotteryDate');
                if (lastDraw === Utils.getToday()) {
                    document.getElementById('drawLotteryBtn').classList.add('hidden');
                    document.getElementById('lotteryLimitHint').classList.remove('hidden');
                    Lottery.showLastResult();
                }
            },
            draw: () => {
                const today = Utils.getToday();
                const type = LotteryData.types[Math.floor(Math.random() * LotteryData.types.length)];
                const result = {
                    type: type,
                    lucky: Utils.randomPick(LotteryData.lucky),
                    unlucky: Utils.randomPick(LotteryData.unlucky),
                    date: today
                };
                localStorage.setItem('lastLotteryResult', JSON.stringify(result));
                localStorage.setItem('lastLotteryDate', today);
                Lottery.showResult(result);
                document.getElementById('drawLotteryBtn').classList.add('hidden');
                document.getElementById('lotteryLimitHint').classList.remove('hidden');
            },
            showResult: (result) => {
                document.getElementById('lotteryResult').classList.remove('hidden');
                document.getElementById('lotteryType').textContent = result.type.name;
                document.getElementById('lotteryImage').src = result.type.icon;
                document.getElementById('lotteryLucky').textContent = result.lucky;
                document.getElementById('lotteryUnlucky').textContent = result.unlucky;
            },
            showLastResult: () => {
                const res = localStorage.getItem('lastLotteryResult');
                if (res) Lottery.showResult(JSON.parse(res));
            }
        };

        // 主题切换
        function switchTheme(theme) {
            document.body.classList.remove('theme1', 'theme2', 'theme3');
            document.body.classList.add(theme);
            localStorage.setItem('preferredTheme', theme);
            Utils.showToast('success', `已切换到${theme === 'theme1' ? '清新蓝' : theme === 'theme2' ? '活力橙' : '森系绿'}主题`);
        }

        // 关键修复2：登录功能（确保事件绑定和逻辑完整）
        const Auth = {
            init: async () => {
                try {
                    await Auth.ensureSuperAdminExists();
                    const user = AV.User.current();
                    if (user) {
                        State.currentUser = user.toJSON();
                        State.isLoggedIn = true;
                        await Auth.checkUserRole();
                        Auth.updateUserDisplay();
                        UI.showContent('homeContent');
                    } else {
                        UI.showContent('authCard');
                    }
                    const savedTheme = localStorage.getItem('preferredTheme');
                    if (savedTheme) switchTheme(savedTheme);
                } catch (err) {
                    console.error('初始化失败:', err);
                    Utils.showToast('error', '系统初始化失败，请刷新重试');
                }
            },
            
            // 确保管理员账号可用（测试用：账号lemon，密码ning6666）
            ensureSuperAdminExists: async () => {
                try {
                    // 检查管理员角色
                    let roleQuery = new AV.Query(AV.Role);
                    roleQuery.equalTo('name', Config.ROLES.SUPER_ADMIN);
                    let roles = await roleQuery.find();
                    if (roles.length === 0) {
                        let role = new AV.Role(Config.ROLES.SUPER_ADMIN, new AV.ACL());
                        role.getACL().setPublicReadAccess(true);
                        await role.save();
                    }
                    
                    // 检查测试账号是否存在
                    let userQuery = new AV.Query(AV.User);
                    userQuery.equalTo('username', 'lemon');
                    let users = await userQuery.find();
                    if (users.length === 0) {
                        let user = new AV.User();
                        user.setUsername('lemon');
                        user.setPassword('ning6666'); // 8位密码，符合要求
                        await user.signUp();
                    }
                } catch (err) {
                    console.error('管理员账号检查失败:', err);
                }
            },
            
            // 登录核心逻辑（修复无响应问题）
            login: async (username, password) => {
                if (password.length !== 8) {
                    document.getElementById('passwordError').classList.remove('hidden');
                    return false;
                }
                
                try {
                    await AV.User.logOut(); // 清除旧登录状态
                    const user = await AV.User.logIn(username, password);
                    State.currentUser = user.toJSON();
                    State.isLoggedIn = true;
                    await Auth.checkUserRole();
                    Auth.updateUserDisplay();
                    Utils.showToast('success', '登录成功！');
                    return true;
                } catch (err) {
                    console.error('登录失败:', err);
                    let msg = '登录失败';
                    if (err.code === 210) msg = '用户名或密码错误';
                    else if (err.code === 211) msg = '用户不存在';
                    Utils.showToast('error', msg);
                    return false;
                }
            },
            
            register: async (username, password) => {
                if (password.length !== 8) {
                    document.getElementById('regPasswordError').classList.remove('hidden');
                    return false;
                }
                
                try {
                    let query = new AV.Query(AV.User);
                    query.equalTo('username', username);
                    let users = await query.find();
                    if (users.length > 0) {
                        Utils.showToast('error', '用户名已存在');
                        return false;
                    }
                    
                    let user = new AV.User();
                    user.setUsername(username);
                    user.setPassword(password);
                    await user.signUp();
                    Utils.showToast('success', '注册成功，请登录');
                    return true;
                } catch (err) {
                    console.error('注册失败:', err);
                    Utils.showToast('error', '注册失败，请稍后再试');
                    return false;
                }
            },
            
            logout: async () => {
                await AV.User.logOut();
                State.currentUser = null;
                State.isLoggedIn = false;
                Auth.updateUserDisplay();
                UI.showContent('authCard');
                Utils.showToast('success', '已退出登录');
            },
            
            updateUserDisplay: () => {
                const avatar = document.getElementById('userAvatar');
                const nickname = document.getElementById('userNickname');
                const dropdownNick = document.getElementById('dropdownNickname');
                const dropdownRole = document.getElementById('dropdownRole');
                const adminBtn = document.getElementById('adminBtn');
                const welcomeNick = document.getElementById('welcomeNickname');
                
                if (State.isLoggedIn) {
                    const avatarUrl = State.currentUser.avatar || `https://picsum.photos/200/200?random=${State.currentUser.objectId}`;
                    avatar.innerHTML = `<img src="${avatarUrl}" alt="用户头像" class="w-full h-full object-cover">`;
                    nickname.textContent = State.currentUser.username;
                    dropdownNick.textContent = State.currentUser.username;
                    welcomeNick.textContent = State.currentUser.username;
                    
                    let roleText = '普通用户';
                    if (State.currentRole === Config.ROLES.SUPER_ADMIN) {
                        roleText = '👑超级管理员';
                        adminBtn.classList.remove('hidden');
                    } else if (State.currentRole === Config.ROLES.ADMIN) {
                        roleText = '🛡️管理员';
                        adminBtn.classList.remove('hidden');
                    } else {
                        adminBtn.classList.add('hidden');
                    }
                    dropdownRole.textContent = roleText;
                } else {
                    avatar.innerHTML = `<img src="https://picsum.photos/200/200?random=1" alt="游客头像">`;
                    nickname.textContent = '游客';
                    dropdownNick.textContent = '游客';
                    dropdownRole.textContent = '未登录';
                    adminBtn.classList.add('hidden');
                }
            },
            
            checkUserRole: async () => {
                if (!State.currentUser) return;
                try {
                    const user = AV.Object.createWithoutData('_User', State.currentUser.objectId);
                    const query = new AV.Query(AV.Role);
                    query.equalTo('users', user);
                    const roles = await query.find();
                    
                    State.currentRole = roles.some(r => r.get('name') === Config.ROLES.SUPER_ADMIN) 
                        ? Config.ROLES.SUPER_ADMIN 
                        : roles.some(r => r.get('name') === Config.ROLES.ADMIN)
                            ? Config.ROLES.ADMIN
                            : Config.ROLES.USER;
                } catch (err) {
                    console.error('获取角色失败:', err);
                    State.currentRole = Config.ROLES.USER;
                }
            }
        };

        // UI控制
        const UI = {
            showContent: (id) => {
                document.querySelectorAll('main > div > div[id$="Content"], #authCard').forEach(el => el.classList.add('hidden'));
                document.getElementById(id).classList.remove('hidden');
                document.querySelectorAll('.sidebar-btn').forEach(btn => btn.classList.remove('sidebar-btn-active'));
                document.querySelector(`.sidebar-btn[data-target="${id}"]`)?.classList.add('sidebar-btn-active');
            }
        };

        // 关键修复3：确保登录按钮事件正确绑定（DOM加载完成后执行）
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化功能
            Auth.init();
            Lottery.init();
            
            // 登录按钮点击事件（核心修复：确保能触发登录逻辑）
            document.getElementById('loginBtn').addEventListener('click', async () => {
                const username = document.getElementById('loginUsername').value.trim();
                const password = document.getElementById('loginPassword').value;
                
                if (!username || !password) {
                    Utils.showToast('error', '请输入用户名和密码');
                    return;
                }
                
                const success = await Auth.login(username, password);
                if (success) {
                    UI.showContent('homeContent'); // 登录成功后跳转到首页
                }
            });
            
            // 注册按钮
            document.getElementById('registerBtn').addEventListener('click', async () => {
                const username = document.getElementById('regUsername').value.trim();
                const password = document.getElementById('regPassword').value;
                
                if (!username || !password) {
                    Utils.showToast('error', '请输入用户名和密码');
                    return;
                }
                
                const success = await Auth.register(username, password);
                if (success) {
                    document.getElementById('registerForm').classList.add('hidden');
                    document.getElementById('loginForm').classList.remove('hidden');
                }
            });
            
            // 其他事件绑定
            document.getElementById('showRegisterBtn').addEventListener('click', () => {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('registerForm').classList.remove('hidden');
            });
            document.getElementById('showLoginBtn').addEventListener('click', () => {
                document.getElementById('registerForm').classList.add('hidden');
                document.getElementById('loginForm').classList.remove('hidden');
            });
            document.getElementById('logoutBtn').addEventListener('click', () => Auth.logout());
            document.getElementById('drawLotteryBtn').addEventListener('click', () => Lottery.draw());
            document.getElementById('userAvatarBtn').addEventListener('click', () => {
                document.getElementById('avatarDropdown').classList.toggle('hidden');
            });
            document.querySelectorAll('.sidebar-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const target = btn.getAttribute('data-target');
                    if (target && State.isLoggedIn) UI.showContent(target);
                    else if (!State.isLoggedIn) Utils.showToast('error', '请先登录');
                });
            });
            document.querySelectorAll('.toggle-password').forEach(btn => {
                btn.addEventListener('click', function() {
                    const input = this.parentElement.querySelector('input');
                    const icon = this.querySelector('i');
                    input.type = input.type === 'password' ? 'text' : 'password';
                    icon.classList.toggle('fa-eye');
                    icon.classList.toggle('fa-eye-slash');
                });
            });
            document.getElementById('loginPassword').addEventListener('input', (e) => {
                document.getElementById('passwordError').classList.toggle('hidden', e.target.value.length === 8);
            });
            document.getElementById('regPassword').addEventListener('input', (e) => {
                document.getElementById('regPasswordError').classList.toggle('hidden', e.target.value.length === 8);
            });
            document.addEventListener('click', (e) => {
                if (!document.getElementById('userMenu').contains(e.target)) {
                    document.getElementById('avatarDropdown').classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>
    
