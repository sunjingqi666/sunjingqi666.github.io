<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校园聊天系统</title>
    <!-- 引入外部资源 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
    
    <!-- 初始化LeanCloud -->
    <script>
        AV.init({
            appId: "0q5QrQ2pGsms6GN3cUn3Xx7f-gzGzoHsz",
            appKey: "m7saMie87OiJizfHwzhcQaEc",
            serverURL: "https://0q5qrq2p.lc-cn-n1-shared.com"
        });
    </script>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- 顶部导航 -->
    <header class="bg-blue-600 text-white shadow-md">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl md:text-2xl font-bold flex items-center">
                <i class="fa fa-comments-o mr-2"></i>校园聊天系统
            </h1>
            <div class="flex items-center space-x-4">
                <button id="announcementBtn" class="hover:text-blue-200 transition relative">
                    <i class="fa fa-bullhorn mr-1"></i> 公告
                    <span id="announcementBadge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center">1</span>
                </button>
                <div id="userArea" class="flex items-center space-x-3">
                    <span id="userNickname" class="hidden md:inline">请登录</span>
                    <img id="userAvatar" src="https://picsum.photos/32?random=default" alt="用户头像" class="w-8 h-8 rounded-full border-2 border-white">
                    <div class="relative group">
                        <button id="userMenuBtn" class="hover:text-blue-200 transition">
                            <i class="fa fa-caret-down"></i>
                        </button>
                        <div id="userMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10">
                            <a href="#" id="profileLink" class="block px-4 py-2 text-gray-800 hover:bg-gray-100">个人资料</a>
                            <a href="#" id="friendsLink" class="block px-4 py-2 text-gray-800 hover:bg-gray-100">我的好友</a>
                            <a href="#" id="logoutLink" class="block px-4 py-2 text-gray-800 hover:bg-gray-100">退出登录</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 py-6 flex flex-col md:flex-row gap-6">
        <!-- 左侧边栏 - 好友列表 -->
        <div id="friendsPanel" class="w-full md:w-64 bg-white rounded-lg shadow-md p-4 h-[calc(100vh-120px)] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-bold text-lg">好友列表</h2>
                <button id="addFriendBtn" class="text-blue-600 hover:text-blue-800">
                    <i class="fa fa-plus-circle"></i>
                </button>
            </div>
            
            <div class="relative mb-4">
                <input type="text" id="friendSearch" placeholder="搜索好友..." class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 pl-9">
                <i class="fa fa-search absolute left-3 top-3 text-gray-400"></i>
            </div>
            
            <div id="friendsList" class="space-y-1">
                <!-- 好友列表将通过JS动态生成 -->
                <div class="text-center text-gray-500 py-8">
                    <i class="fa fa-user-o text-4xl mb-2"></i>
                    <p>登录后查看好友</p>
                </div>
            </div>
        </div>

        <!-- 中间区域 - 聊天界面 -->
        <div id="chatPanel" class="flex-1 bg-white rounded-lg shadow-md flex flex-col h-[calc(100vh-120px)]">
            <!-- 聊天标题栏 -->
            <div id="chatHeader" class="border-b p-4 flex justify-between items-center">
                <h2 class="font-bold text-gray-800">选择一个好友开始聊天</h2>
                <div>
                    <button id="clearChatBtn" class="text-gray-500 hover:text-gray-700 mr-2" disabled>
                        <i class="fa fa-trash-o"></i>
                    </button>
                </div>
            </div>
            
            <!-- 聊天消息区域 -->
            <div id="messagesArea" class="flex-1 p-4 overflow-y-auto bg-gray-50">
                <div class="text-center text-gray-500 py-12">
                    <i class="fa fa-comments text-4xl mb-2"></i>
                    <p>聊天记录将在这里显示</p>
                </div>
            </div>
            
            <!-- 消息输入区域 -->
            <div id="inputArea" class="border-t p-4" disabled>
                <div class="flex gap-2">
                    <textarea id="messageInput" placeholder="输入消息..." class="flex-1 border border-gray-300 rounded p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none" rows="3" disabled></textarea>
                    <div class="flex flex-col gap-2">
                        <button id="sendImageBtn" class="bg-gray-200 p-2 rounded hover:bg-gray-300 transition" disabled>
                            <i class="fa fa-image"></i>
                        </button>
                        <button id="sendMessageBtn" class="bg-blue-600 text-white p-2 rounded hover:bg-blue-700 transition" disabled>
                            <i class="fa fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 模态框 -->
    <!-- 登录模态框 -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">用户登录</h2>
                <button class="closeModal text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="loginAccount" class="block text-gray-700 mb-1">账号</label>
                    <input type="text" id="loginAccount" required class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="loginPassword" class="block text-gray-700 mb-1">密码</label>
                    <input type="password" id="loginPassword" required minlength="8" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">
                    <i class="fa fa-sign-in mr-1"></i> 登录
                </button>
                <div class="text-center">
                    <span class="text-gray-600">还没有账号？</span>
                    <button type="button" id="showRegisterBtn" class="text-blue-600 hover:underline">立即注册</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 注册模态框 -->
    <div id="registerModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">用户注册</h2>
                <button class="closeModal text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <form id="registerForm" class="space-y-4">
                <div>
                    <label for="regAccount" class="block text-gray-700 mb-1">账号</label>
                    <input type="text" id="regAccount" required class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="regPassword" class="block text-gray-700 mb-1">密码（至少8位）</label>
                    <input type="password" id="regPassword" required minlength="8" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="regNickname" class="block text-gray-700 mb-1">昵称</label>
                    <input type="text" id="regNickname" required class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="regAvatar" class="block text-gray-700 mb-1">头像URL（可选）</label>
                    <input type="text" id="regAvatar" placeholder="https://picsum.photos/200" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button type="submit" class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600 transition">
                    <i class="fa fa-user-plus mr-1"></i> 注册
                </button>
                <div class="text-center">
                    <span class="text-gray-600">已有账号？</span>
                    <button type="button" id="showLoginBtn" class="text-blue-600 hover:underline">立即登录</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 个人资料模态框 -->
    <div id="profileModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">个人资料</h2>
                <button class="closeModal text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <form id="profileForm" class="space-y-4">
                <div class="text-center">
                    <img id="profileAvatar" src="https://picsum.photos/200?random=default" alt="用户头像" class="w-24 h-24 rounded-full mx-auto mb-2 border-4 border-blue-100">
                    <input type="text" id="profileAvatarUrl" placeholder="头像URL" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="profileAccount" class="block text-gray-700 mb-1">账号（不可修改）</label>
                    <input type="text" id="profileAccount" readonly class="w-full px-3 py-2 border border-gray-300 rounded bg-gray-100">
                </div>
                <div>
                    <label for="profileNickname" class="block text-gray-700 mb-1">昵称</label>
                    <input type="text" id="profileNickname" required class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">
                    <i class="fa fa-save mr-1"></i> 保存修改
                </button>
            </form>
        </div>
    </div>

    <!-- 添加好友模态框 -->
    <div id="addFriendModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">添加好友</h2>
                <button class="closeModal text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <form id="addFriendForm" class="space-y-4">
                <div>
                    <label for="friendAccount" class="block text-gray-700 mb-1">好友账号</label>
                    <input type="text" id="friendAccount" required class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="friendRemark" class="block text-gray-700 mb-1">备注（可选）</label>
                    <input type="text" id="friendRemark" placeholder="给好友起个备注吧" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">
                    <i class="fa fa-user-plus mr-1"></i> 发送好友请求
                </button>
            </form>
        </div>
    </div>

    <!-- 公告模态框 -->
    <div id="announcementModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 transform transition-all max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">系统公告</h2>
                <button class="closeModal text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div id="announcementsList" class="space-y-4">
                <!-- 公告内容将通过JS动态生成 -->
            </div>
            <div class="mt-6 text-center">
                <button id="markAsReadBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition hidden">
                    <i class="fa fa-check mr-1"></i> 标记全部为已读
                </button>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentUser = null;
        let currentFriend = null;
        let unreadAnnouncements = 0;

        // DOM元素
        const loginModal = document.getElementById('loginModal');
        const registerModal = document.getElementById('registerModal');
        const profileModal = document.getElementById('profileModal');
        const addFriendModal = document.getElementById('addFriendModal');
        const announcementModal = document.getElementById('announcementModal');
        
        const userNickname = document.getElementById('userNickname');
        const userAvatar = document.getElementById('userAvatar');
        const friendsList = document.getElementById('friendsList');
        const messagesArea = document.getElementById('messagesArea');
        const messageInput = document.getElementById('messageInput');
        const chatHeader = document.getElementById('chatHeader');
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', init);

        // 初始化函数
        async function init() {
            // 绑定事件监听器
            bindEventListeners();
            
            // 检查登录状态
            const user = AV.User.current();
            if (user) {
                currentUser = user;
                await loadUserInfo();
                await loadFriends();
                await loadAnnouncements();
                hideModal(loginModal);
            } else {
                showModal(loginModal);
            }
        }

        // 绑定事件监听器
        function bindEventListeners() {
            // 模态框关闭按钮
            document.querySelectorAll('.closeModal').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.closest('.fixed').classList.add('hidden');
                });
            });
            
            // 登录/注册切换
            document.getElementById('showRegisterBtn').addEventListener('click', () => {
                hideModal(loginModal);
                showModal(registerModal);
            });
            
            document.getElementById('showLoginBtn').addEventListener('click', () => {
                hideModal(registerModal);
                showModal(loginModal);
            });
            
            // 登录表单提交
            document.getElementById('loginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const account = document.getElementById('loginAccount').value.trim();
                const password = document.getElementById('loginPassword').value;
                
                try {
                    const user = await AV.User.logIn(account, password);
                    currentUser = user;
                    await loadUserInfo();
                    await loadFriends();
                    await loadAnnouncements();
                    this.reset();
                    hideModal(loginModal);
                    showToast('登录成功');
                } catch (error) {
                    showToast(`登录失败: ${error.message}`);
                }
            });
            
            // 注册表单提交
            document.getElementById('registerForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const account = document.getElementById('regAccount').value.trim();
                const password = document.getElementById('regPassword').value;
                const nickname = document.getElementById('regNickname').value.trim();
                let avatarUrl = document.getElementById('regAvatar').value.trim() || `https://picsum.photos/200?random=${account}`;
                
                try {
                    // 创建用户
                    const user = new AV.User();
                    user.setUsername(account);
                    user.setPassword(password);
                    await user.signUp();
                    
                    // 创建用户资料
                    const UserProfile = AV.Object.extend('UserProfile');
                    const profile = new UserProfile();
                    profile.set('userId', user.id);
                    profile.set('nickname', nickname);
                    profile.set('avatarUrl', avatarUrl);
                    profile.set('friends', []);
                    
                    const acl = new AV.ACL();
                    acl.setReadAccess(user, true);
                    acl.setWriteAccess(user, true);
                    profile.setACL(acl);
                    
                    await profile.save();
                    
                    this.reset();
                    hideModal(registerModal);
                    showModal(loginModal);
                    showToast('注册成功，请登录');
                } catch (error) {
                    if (error.code === 202) {
                        showToast('该账号已存在');
                    } else {
                        showToast(`注册失败: ${error.message}`);
                    }
                }
            });
            
            // 用户菜单
            document.getElementById('userMenuBtn').addEventListener('click', function(e) {
                e.stopPropagation();
                document.getElementById('userMenu').classList.toggle('hidden');
            });
            
            // 点击其他地方关闭用户菜单
            document.addEventListener('click', () => {
                document.getElementById('userMenu').classList.add('hidden');
            });
            
            // 个人资料
            document.getElementById('profileLink').addEventListener('click', async function(e) {
                e.preventDefault();
                if (!currentUser) return;
                
                const profile = await getUserProfile(currentUser.id);
                document.getElementById('profileAccount').value = currentUser.getUsername();
                document.getElementById('profileNickname').value = profile.get('nickname');
                document.getElementById('profileAvatarUrl').value = profile.get('avatarUrl');
                document.getElementById('profileAvatar').src = profile.get('avatarUrl');
                
                showModal(profileModal);
            });
            
            // 保存个人资料
            document.getElementById('profileForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                if (!currentUser) return;
                
                try {
                    const profile = await getUserProfile(currentUser.id);
                    const nickname = document.getElementById('profileNickname').value.trim();
                    let avatarUrl = document.getElementById('profileAvatarUrl').value.trim();
                    
                    if (!avatarUrl) {
                        avatarUrl = `https://picsum.photos/200?random=${currentUser.id}`;
                    }
                    
                    profile.set('nickname', nickname);
                    profile.set('avatarUrl', avatarUrl);
                    await profile.save();
                    
                    // 更新UI
                    userNickname.textContent = nickname;
                    userAvatar.src = avatarUrl;
                    
                    hideModal(profileModal);
                    showToast('资料更新成功');
                } catch (error) {
                    showToast(`更新失败: ${error.message}`);
                }
            });
            
            // 退出登录
            document.getElementById('logoutLink').addEventListener('click', async function(e) {
                e.preventDefault();
                try {
                    await AV.User.logOut();
                    currentUser = null;
                    currentFriend = null;
                    
                    // 重置UI
                    userNickname.textContent = '请登录';
                    userAvatar.src = 'https://picsum.photos/32?random=default';
                    friendsList.innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <i class="fa fa-user-o text-4xl mb-2"></i>
                            <p>登录后查看好友</p>
                        </div>
                    `;
                    messagesArea.innerHTML = `
                        <div class="text-center text-gray-500 py-12">
                            <i class="fa fa-comments text-4xl mb-2"></i>
                            <p>聊天记录将在这里显示</p>
                        </div>
                    `;
                    chatHeader.innerHTML = `<h2 class="font-bold text-gray-800">选择一个好友开始聊天</h2>`;
                    disableChatInput(true);
                    
                    showModal(loginModal);
                    showToast('已退出登录');
                } catch (error) {
                    showToast(`退出失败: ${error.message}`);
                }
            });
            
            // 添加好友按钮
            document.getElementById('addFriendBtn').addEventListener('click', () => {
                if (!currentUser) {
                    showToast('请先登录');
                    return;
                }
                document.getElementById('addFriendForm').reset();
                showModal(addFriendModal);
            });
            
            // 添加好友表单提交
            document.getElementById('addFriendForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                if (!currentUser) return;
                
                const friendAccount = document.getElementById('friendAccount').value.trim();
                const friendRemark = document.getElementById('friendRemark').value.trim();
                
                try {
                    // 查找好友账号对应的用户
                    const userQuery = new AV.Query('_User');
                    userQuery.equalTo('username', friendAccount);
                    const friendUser = await userQuery.first();
                    
                    if (!friendUser) {
                        showToast('该用户不存在');
                        return;
                    }
                    
                    if (friendUser.id === currentUser.id) {
                        showToast('不能添加自己为好友');
                        return;
                    }
                    
                    // 检查是否已经是好友
                    const currentProfile = await getUserProfile(currentUser.id);
                    const friends = currentProfile.get('friends') || [];
                    
                    if (friends.some(f => f.userId === friendUser.id)) {
                        showToast('该用户已经是你的好友');
                        return;
                    }
                    
                    // 获取好友的资料
                    const friendProfile = await getUserProfile(friendUser.id);
                    
                    // 添加到当前用户的好友列表
                    friends.push({
                        userId: friendUser.id,
                        account: friendUser.getUsername(),
                        nickname: friendProfile.get('nickname'),
                        avatarUrl: friendProfile.get('avatarUrl'),
                        remark: friendRemark || friendProfile.get('nickname'),
                        addedAt: new Date().toISOString()
                    });
                    
                    currentProfile.set('friends', friends);
                    await currentProfile.save();
                    
                    // 刷新好友列表
                    await loadFriends();
                    
                    hideModal(addFriendModal);
                    showToast('好友添加成功');
                } catch (error) {
                    showToast(`添加失败: ${error.message}`);
                }
            });
            
            // 公告按钮
            document.getElementById('announcementBtn').addEventListener('click', async () => {
                if (!currentUser) {
                    showToast('请先登录');
                    return;
                }
                
                await loadAnnouncements(true);
                showModal(announcementModal);
            });
            
            // 标记公告为已读
            document.getElementById('markAsReadBtn').addEventListener('click', async () => {
                if (!currentUser) return;
                
                try {
                    const profile = await getUserProfile(currentUser.id);
                    profile.set('lastReadAnnouncement', new Date().toISOString());
                    await profile.save();
                    
                    unreadAnnouncements = 0;
                    updateAnnouncementBadge();
                    document.getElementById('markAsReadBtn').classList.add('hidden');
                    showToast('已标记全部公告为已读');
                } catch (error) {
                    showToast(`操作失败: ${error.message}`);
                }
            });
            
            // 发送消息
            document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // 清空聊天记录
            document.getElementById('clearChatBtn').addEventListener('click', async () => {
                if (!currentUser || !currentFriend) return;
                
                if (confirm('确定要清空与该好友的聊天记录吗？')) {
                    try {
                        const ChatMessage = AV.Object.extend('ChatMessage');
                        const query = new AV.Query(ChatMessage);
                        query.equalTo('userId', currentUser.id);
                        query.equalTo('friendId', currentFriend.userId);
                        const messages = await query.find();
                        
                        if (messages.length > 0) {
                            await AV.Object.destroyAll(messages);
                        }
                        
                        messagesArea.innerHTML = '';
                        showToast('聊天记录已清空');
                    } catch (error) {
                        showToast(`操作失败: ${error.message}`);
                    }
                }
            });
        }

        // 加载用户信息
        async function loadUserInfo() {
            if (!currentUser) return;
            
            try {
                const profile = await getUserProfile(currentUser.id);
                userNickname.textContent = profile.get('nickname');
                userAvatar.src = profile.get('avatarUrl');
                disableChatInput(false);
            } catch (error) {
                console.error('加载用户信息失败:', error);
                showToast('加载用户信息失败');
            }
        }

        // 加载好友列表
        async function loadFriends() {
            if (!currentUser) return;
            
            try {
                const profile = await getUserProfile(currentUser.id);
                const friends = profile.get('friends') || [];
                
                if (friends.length === 0) {
                    friendsList.innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <i class="fa fa-users text-4xl mb-2"></i>
                            <p>你还没有好友，添加一个吧</p>
                        </div>
                    `;
                    return;
                }
                
                // 生成好友列表HTML
                let friendsHTML = '';
                friends.forEach(friend => {
                    friendsHTML += `
                        <div class="friend-item p-2 hover:bg-gray-100 rounded flex items-center cursor-pointer transition" 
                             data-user-id="${friend.userId}">
                            <img src="${friend.avatarUrl}" alt="${friend.nickname}" class="w-10 h-10 rounded-full mr-3">
                            <div class="flex-1 min-w-0">
                                <p class="font-medium text-gray-800 truncate">${friend.remark || friend.nickname}</p>
                                <p class="text-xs text-gray-500 truncate">${friend.account}</p>
                            </div>
                            <span class="friend-unread hidden bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
                        </div>
                    `;
                });
                
                friendsList.innerHTML = friendsHTML;
                
                // 绑定好友点击事件
                document.querySelectorAll('.friend-item').forEach(item => {
                    item.addEventListener('click', async function() {
                        // 移除其他好友的选中状态
                        document.querySelectorAll('.friend-item').forEach(i => 
                            i.classList.remove('bg-blue-50'));
                        
                        // 添加当前好友的选中状态
                        this.classList.add('bg-blue-50');
                        
                        // 获取好友信息
                        const userId = this.getAttribute('data-user-id');
                        currentFriend = friends.find(f => f.userId === userId);
                        
                        // 更新聊天标题
                        chatHeader.innerHTML = `
                            <div class="flex items-center">
                                <img src="${currentFriend.avatarUrl}" alt="${currentFriend.nickname}" class="w-8 h-8 rounded-full mr-2">
                                <h2 class="font-bold text-gray-800">${currentFriend.remark || currentFriend.nickname}</h2>
                            </div>
                            <div>
                                <button id="clearChatBtn" class="text-gray-500 hover:text-gray-700 mr-2">
                                    <i class="fa fa-trash-o"></i>
                                </button>
                            </div>
                        `;
                        
                        // 加载聊天记录
                        await loadChatMessages();
                        
                        // 重置未读消息计数
                        this.querySelector('.friend-unread').classList.add('hidden');
                        this.querySelector('.friend-unread').textContent = '0';
                    });
                });
                
                // 检查未读消息
                await checkUnreadMessages();
            } catch (error) {
                console.error('加载好友列表失败:', error);
                showToast('加载好友列表失败');
            }
        }

        // 加载聊天记录
        async function loadChatMessages() {
            if (!currentUser || !currentFriend) return;
            
            try {
                const ChatMessage = AV.Object.extend('ChatMessage');
                const query = new AV.Query(ChatMessage);
                
                // 查询与当前好友的聊天记录
                query.equalTo('userId', currentUser.id);
                query.equalTo('friendId', currentFriend.userId);
                
                // 按时间排序，只取最近20条
                query.descending('createdAt');
                query.limit(20);
                
                const messages = await query.find();
                // 反转顺序，让最早的消息在前面
                messages.reverse();
                
                // 清空消息区域
                messagesArea.innerHTML = '';
                
                // 添加消息到界面
                messages.forEach(message => {
                    addMessageToUI(
                        message.get('content'),
                        message.get('isSentByMe'),
                        new Date(message.get('createdAt'))
                    );
                });
                
                // 滚动到底部
                scrollToBottom();
            } catch (error) {
                console.error('加载聊天记录失败:', error);
                showToast('加载聊天记录失败');
            }
        }

        // 发送消息
        async function sendMessage() {
            if (!currentUser || !currentFriend) return;
            
            const content = messageInput.value.trim();
            if (!content) return;
            
            try {
                // 添加到UI
                const now = new Date();
                addMessageToUI(content, true, now);
                
                // 清空输入框
                messageInput.value = '';
                scrollToBottom();
                
                // 保存到LeanCloud
                const ChatMessage = AV.Object.extend('ChatMessage');
                const message = new ChatMessage();
                
                message.set('userId', currentUser.id);
                message.set('friendId', currentFriend.userId);
                message.set('content', content);
                message.set('isSentByMe', true);
                message.set('createdAt', now);
                
                const acl = new AV.ACL();
                acl.setReadAccess(currentUser, true);
                acl.setWriteAccess(currentUser, true);
                message.setACL(acl);
                
                await message.save();
                
                // 检查并清理旧消息，只保留最近20条
                await keepRecentMessagesOnly(20);
                
            } catch (error) {
                console.error('发送消息失败:', error);
                showToast('发送消息失败');
            }
        }

        // 只保留最近的N条消息
        async function keepRecentMessagesOnly(limit) {
            if (!currentUser || !currentFriend) return;
            
            try {
                const ChatMessage = AV.Object.extend('ChatMessage');
                const query = new AV.Query(ChatMessage);
                
                query.equalTo('userId', currentUser.id);
                query.equalTo('friendId', currentFriend.userId);
                query.descending('createdAt');
                query.limit(limit + 1); // 查询比限制多一条
                
                const messages = await query.find();
                
                // 如果消息数量超过限制，删除多余的
                if (messages.length > limit) {
                    const messagesToDelete = messages.slice(limit);
                    await AV.Object.destroyAll(messagesToDelete);
                }
            } catch (error) {
                console.error('清理旧消息失败:', error);
            }
        }

        // 检查未读消息
        async function checkUnreadMessages() {
            // 实际项目中可以通过实时通信实现
            // 这里简化处理，不做实际检查
        }

        // 加载公告
        async function loadAnnouncements(markAsRead = false) {
            if (!currentUser) return;
            
            try {
                const Announcement = AV.Object.extend('Announcement');
                const query = new AV.Query(Announcement);
                query.descending('createdAt');
                query.limit(10);
                
                const announcements = await query.find();
                const profile = await getUserProfile(currentUser.id);
                const lastRead = profile.get('lastReadAnnouncement') || new Date(0).toISOString();
                
                let announcementsHTML = '';
                unreadAnnouncements = 0;
                
                announcements.forEach(announcement => {
                    const createdAt = new Date(announcement.get('createdAt'));
                    const isUnread = createdAt.toISOString() > lastRead;
                    
                    if (isUnread) {
                        unreadAnnouncements++;
                    }
                    
                    announcementsHTML += `
                        <div class="announcement-item p-3 border rounded-lg ${isUnread ? 'bg-blue-50 border-blue-200' : 'bg-gray-50 border-gray-200'}">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-bold text-gray-800">${announcement.get('title')}</h3>
                                ${isUnread ? '<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">新</span>' : ''}
                            </div>
                            <p class="text-gray-700 mb-2">${announcement.get('content')}</p>
                            <p class="text-xs text-gray-500">发布时间: ${formatDate(createdAt)}</p>
                        </div>
                    `;
                });
                
                document.getElementById('announcementsList').innerHTML = announcementsHTML;
                updateAnnouncementBadge();
                
                // 如果是在查看公告，且有未读公告，显示"标记全部为已读"按钮
                if (markAsRead && unreadAnnouncements > 0) {
                    document.getElementById('markAsReadBtn').classList.remove('hidden');
                } else {
                    document.getElementById('markAsReadBtn').classList.add('hidden');
                }
                
                // 如果是首次加载且有未读公告，创建一个系统公告（仅管理员可创建，这里简化处理）
                if (announcements.length === 0) {
                    await createDefaultAnnouncement();
                    await loadAnnouncements(markAsRead);
                }
            } catch (error) {
                console.error('加载公告失败:', error);
                showToast('加载公告失败');
            }
        }

        // 创建默认公告
        async function createDefaultAnnouncement() {
            try {
                // 检查是否已经有默认公告
                const Announcement = AV.Object.extend('Announcement');
                const query = new AV.Query(Announcement);
                query.equalTo('title', '欢迎使用校园聊天系统');
                const existing = await query.first();
                
                if (existing) return;
                
                // 创建默认公告
                const announcement = new Announcement();
                announcement.set('title', '欢迎使用校园聊天系统');
                announcement.set('content', '这是一个基于LeanCloud的校园聊天系统，可以添加好友、发送消息，所有数据都会安全保存。');
                announcement.set('createdAt', new Date());
                
                const acl = new AV.ACL();
                acl.setPublicReadAccess(true);
                acl.setPublicWriteAccess(false); // 只有管理员可以创建公告
                announcement.setACL(acl);
                
                await announcement.save();
            } catch (error) {
                console.error('创建默认公告失败:', error);
            }
        }

        // 更新公告未读徽章
        function updateAnnouncementBadge() {
            const badge = document.getElementById('announcementBadge');
            if (unreadAnnouncements > 0) {
                badge.textContent = unreadAnnouncements;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // 辅助函数：获取用户资料
        async function getUserProfile(userId) {
            const UserProfile = AV.Object.extend('UserProfile');
            const query = new AV.Query(UserProfile);
            query.equalTo('userId', userId);
            return await query.first();
        }

        // 辅助函数：添加消息到UI
        function addMessageToUI(content, isSentByMe, time) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message mb-4 ${isSentByMe ? 'flex justify-end' : 'flex'}`;
            
            const messageBubble = document.createElement('div');
            messageBubble.className = `max-w-[80%] px-4 py-2 rounded-lg ${
                isSentByMe ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-gray-200 text-gray-800 rounded-tl-none'
            }`;
            
            messageBubble.innerHTML = `
                <p>${content}</p>
                <p class="text-xs mt-1 opacity-70 text-right">${formatTime(time)}</p>
            `;
            
            messageDiv.appendChild(messageBubble);
            messagesArea.appendChild(messageDiv);
        }

        // 辅助函数：滚动到消息底部
        function scrollToBottom() {
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        // 辅助函数：禁用/启用聊天输入
        function disableChatInput(disabled) {
            messageInput.disabled = disabled;
            document.getElementById('sendMessageBtn').disabled = disabled;
            document.getElementById('sendImageBtn').disabled = disabled;
            document.getElementById('clearChatBtn').disabled = disabled;
            
            if (disabled) {
                messageInput.classList.add('bg-gray-100');
            } else {
                messageInput.classList.remove('bg-gray-100');
            }
        }

        // 辅助函数：显示模态框
        function showModal(modal) {
            modal.classList.remove('hidden');
        }

        // 辅助函数：隐藏模态框
        function hideModal(modal) {
            modal.classList.add('hidden');
        }

        // 辅助函数：显示提示消息
        function showToast(message) {
            // 检查是否已有toast
            let toast = document.getElementById('toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast';
                toast.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded shadow-lg z-50 transition-opacity duration-300';
                document.body.appendChild(toast);
            }
            
            toast.textContent = message;
            toast.style.opacity = '1';
            
            // 3秒后隐藏
            setTimeout(() => {
                toast.style.opacity = '0';
            }, 3000);
        }

        // 辅助函数：格式化时间
        function formatTime(date) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // 辅助函数：格式化日期
        function formatDate(date) {
            return date.toLocaleString();
        }
    </script>
</body>
</html>
